<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Map - AID-X: Smart Humanitarian Support Platform</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'primary': '#00b4d8',
                    'secondary': '#48cae4',
                    'accent': '#90e0ef',
                    'background': '#003049'
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                backgroundImage: {
                    'hero-pattern': "url('https://images.unsplash.com/photo-1543269865-cbe426643c99?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D')",
                }
            }
        }
    }
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
  
  .hero-background {
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
  }
  
  .hamburger-menu {
      display: flex;
      flex-direction: column;
      cursor: pointer;
  }
  
  .hamburger-line {
      width: 25px;
      height: 3px;
      background-color: white;
      margin: 3px 0;
      transition: 0.3s;
      border-radius: 2px;
      display: block;
  }
  
  @media (max-width: 767px) {
      .hamburger-menu {
          display: flex !important;
      }
  }
  
  .hamburger-menu.active .hamburger-line:nth-child(1) {
      transform: rotate(-45deg) translate(-5px, 6px);
  }
  
  .hamburger-menu.active .hamburger-line:nth-child(2) {
      opacity: 0;
  }
  
  .hamburger-menu.active .hamburger-line:nth-child(3) {
      transform: rotate(45deg) translate(-5px, -6px);
  }
  
  @keyframes fadeIn {
      from {
          opacity: 0;
          transform: translateY(20px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }
  
  .animate-fade-in {
      animation: fadeIn 1s ease-out;
  }
  #map {
    height: 80vh; border-radius: 16px; box-shadow: 0 12px 48px rgba(0,180,216,0.4); border: 2px solid #00b4d8;
  }
  #sidebar {
    background: rgba(255,255,255,0.1); backdrop-filter: blur(16px); border-radius: 16px; padding: 18px; box-sizing: border-box;
    display: flex; flex-direction: column; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2);
  }
  #search-section {
    margin-bottom: 28px; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 16px;
  }
  #search-section h2 { margin:0 0 12px 0; font-size: 1.2rem; color: white; }
  #searchBox {
    position: relative; z-index: 5;
  }
  #searchInput {
    width: 100%; padding:12px 16px; border-radius:8px; border:1px solid rgba(255,255,255,0.3); font-size:1.1rem; min-width:0;
    background: rgba(0,0,0,0.3); color: white; backdrop-filter: blur(8px); cursor: text;
    position: relative; z-index: 10; pointer-events: auto; height: 48px;
  }
  #searchInput::placeholder { color: rgba(255,255,255,0.7); }
  #searchInput:focus {
    outline: none; border-color: #00b4d8; background: rgba(0,0,0,0.4); z-index: 20;
  }
  #searchInput:hover {
    background: rgba(0,0,0,0.4); border-color: rgba(255,255,255,0.5);
  }
  #searchBtn { 
    background: #00b4d8; color:white; border:none; font-weight:600; border-radius:8px; padding:12px 16px; cursor:pointer; transition: background 0.3s;
    font-size: 1rem; min-height: 44px; display: flex; align-items: center; justify-content: center;
  }
  #searchBtn:hover { background:#48cae4; }
  #resetBtn {
    background:#ef4444; color:white; border:none; border-radius:8px; padding:12px 16px; cursor:pointer; font-size:1rem; transition: background 0.3s;
    min-height: 44px; display: flex; align-items: center; justify-content: center;
  }
  #resetBtn:hover { background:#dc2626; }
  #active-section h2 { margin-top: 0; margin-bottom:15px; font-size: 1.25rem; color: white; }
  .priority-section {
    margin-bottom: 20px; border-left: 4px solid; padding-left: 10px;
  }
  .priority-section.high { border-left-color: #ef4444; }
  .priority-section.medium { border-left-color: #f59e0b; }
  .priority-section.low { border-left-color: #10b981; }
  .priority-section h3 { 
    margin: 0 0 10px 0; font-size: 1.1rem; font-weight: 700; color: white;
  }
  .no-problems {
    text-align: center; color: rgba(255,255,255,0.7); font-style: italic; padding: 20px;
  }
  #sidebar div.problem {
    padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.2); cursor: pointer; transition: background 0.3s; border-radius: 6px; margin-bottom: 8px;
    background: rgba(255,255,255,0.05);
  }
  #sidebar div.problem:hover { background-color: rgba(255,255,255,0.1); }
  #sidebar .field { margin-bottom: 4px; font-size: 0.95rem; color: rgba(255,255,255,0.9); }
  #sidebar .field strong { color: #48cae4; }
  #loading { text-align: center; color: white; font-style: italic; display: none; }
  @media (max-width: 768px) {
    #container { flex-direction: column; }
    #sidebar { width: 100%; height: auto; max-height: 50vh; }
    nav.navbar ul.nav-links { flex-direction: column; }
  }
</style>
</head>
<body class="font-sans min-h-screen bg-gray-50">

<div class="hero-background bg-hero-pattern min-h-screen flex flex-col relative">
    <div class="absolute inset-0 bg-background opacity-80 backdrop-blur-sm pointer-events-none"></div>

    <header class="relative z-10 bg-white/10 backdrop-blur-md border-b border-white/20">
        <nav class="flex justify-between items-center max-w-7xl mx-auto px-6 py-4">
            <div class="text-2xl md:text-3xl font-extrabold text-white tracking-wider flex items-center">
                <svg class="w-6 h-6 md:w-8 md:h-8 mr-2 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
                AID-<span class="text-secondary">X</span>
            </div>

            <div class="flex items-center space-x-2 lg:hidden">
                <button class="p-2 bg-white bg-opacity-20 rounded-lg" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <div class="hamburger-menu">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </div>
                </button>
            </div>
            
            <div class="hidden lg:flex items-center space-x-4 xl:space-x-8">
                <a href="../index.html" class="text-white hover:text-secondary transition duration-200 font-medium text-sm xl:text-base">Home</a>
                <a href="../index.html#about" class="text-white hover:text-secondary transition duration-200 font-medium text-sm xl:text-base">About</a>
                <a href="../index.html#services" class="text-white hover:text-secondary transition duration-200 font-medium text-sm xl:text-base">Services</a>
                <a href="map.html" class="text-white hover:text-secondary transition duration-200 font-medium text-sm xl:text-base">Map</a>
                <a href="../index.html#contact" class="text-white hover:text-secondary transition duration-200 font-medium text-sm xl:text-base">Contact</a>
                <a href="../php/signin.php" class="text-white hover:text-secondary transition duration-200 font-medium text-sm xl:text-base">Login</a>
                <a href="../php/singup.php" class="bg-primary hover:bg-secondary text-white px-4 py-2 xl:px-6 xl:py-2 rounded-full transition duration-200 font-medium text-sm xl:text-base">Sign Up</a>
            </div>

        </nav>
    </header>
    
    <div id="mobile-nav" class="hidden lg:hidden relative z-20 bg-white/10 backdrop-blur-md border-b border-white/20">
        <div class="px-6 py-4 space-y-3">
            <a href="../index.html" class="block px-3 py-2 text-white hover:text-secondary rounded-lg transition duration-200 font-medium">Home</a>
            <a href="../index.html#about" class="block px-3 py-2 text-white hover:text-secondary rounded-lg transition duration-200 font-medium">About</a>
            <a href="../index.html#services" class="block px-3 py-2 text-white hover:text-secondary rounded-lg transition duration-200 font-medium">Services</a>
            <a href="map.html" class="block px-3 py-2 text-white hover:text-secondary rounded-lg transition duration-200 font-medium">Map</a>
            <a href="../index.html#contact" class="block px-3 py-2 text-white hover:text-secondary rounded-lg transition duration-200 font-medium">Contact</a>
            <a href="../php/signin.php" class="block px-3 py-2 text-white hover:text-secondary rounded-lg transition duration-200 font-medium">Login</a>
            <a href="../php/singup.php" class="block px-3 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition duration-200 font-medium text-center">Sign Up</a>
        </div>
    </div>

    <div class="relative z-30 flex-1 p-6">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">Real-time Aid Request Map</h1>
            <p class="text-xl text-gray-300">Track and coordinate humanitarian aid in real-time</p>
        </div>
        
        <div class="max-w-7xl mx-auto grid lg:grid-cols-4 gap-6">
            <div class="lg:col-span-3">
                <div id="map" class="w-full"></div>
            </div>
            <div class="lg:col-span-1">
                <div id="sidebar">
    <div id="search-section">
      <h2>Search</h2>
      <div id="searchBox">
        <input type="text" id="searchInput" placeholder="Enter location (e.g., Delhi), aid type, name, etc.">
      </div>
      <div class="mt-3 flex gap-2">
        <button id="searchBtn" class="flex-1" onclick="doSearch()">Search</button>
        <button id="resetBtn" class="flex-1" onclick="resetSearch()">Reset</button>
      </div>
    </div>
    
    <div class="mb-6">
      <button id="addRequestBtn" class="w-full bg-primary hover:bg-secondary text-white font-semibold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-[1.02] shadow-lg">
        <i class="fas fa-plus mr-2"></i>Add Aid Request
      </button>
    </div>
    
    <div id="active-section">
      <h2>Active Problems</h2>
      <div id="problems-list">
        <div id="loading">Loading active problems...</div>
      </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
const map = L.map('map').setView([23.5937, 80.9629], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution: '&copy; OpenStreetMap contributors',
  maxZoom: 18
}).addTo(map);

const levelIcons = {
  'Low': 'green',
  'Medium': 'orange',
  'High': 'red'
};

function createColoredIcon(color) {
  return new L.Icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
  });
}

let allRequests = [];
let allMarkers = [];

async function fetchRequests() {
  try {
    const response = await fetch('request.php');
    if(!response.ok) throw new Error(response.statusText);
    const data = await response.json();
    console.log('Backend data loaded:', data);
    const mockData = [
      {fullname: "John Doe", address: "Delhi", latitude: 28.6139, longitude: 77.2090, aidtype: "Food", details: "Urgent ration needed", type: "High", phone: "9876543210", emergency_level: "High"},
      {fullname: "Jane Smith", address: "Ludhiana", latitude: 30.9010, longitude: 75.8573, aidtype: "Medical", details: "Blood donation required", type: "Medium", phone: "9876543211", emergency_level: "Medium"},
      {fullname: "Test User", address: "Mumbai", latitude: 19.0760, longitude: 72.8777, aidtype: "Volunteer", details: "Help with relief", type: "Low", phone: "9876543212", emergency_level: "Low"}
    ];
    return [...data, ...mockData];
  } catch (error) {
    console.error('Error fetching requests:', error);
    return [
      {fullname: "John Doe", address: "Delhi", latitude: 28.6139, longitude: 77.2090, aidtype: "Food", details: "Urgent ration needed", type: "High", phone: "9876543210", emergency_level: "High"},
      {fullname: "Jane Smith", address: "Ludhiana", latitude: 30.9010, longitude: 75.8573, aidtype: "Medical", details: "Blood donation required", type: "Medium", phone: "9876543211", emergency_level: "Medium"},
      {fullname: "Test User", address: "Mumbai", latitude: 19.0760, longitude: 72.8777, aidtype: "Volunteer", details: "Help with relief", type: "Low", phone: "9876543212", emergency_level: "Low"}
    ];
  }
}

function renderMarkers(requests) {
  allMarkers.forEach(m => map.removeLayer(m));
  allMarkers = [];
  const problemsList = document.getElementById('problems-list');
  problemsList.innerHTML = '';
  const loadingEl = document.getElementById('loading');
  loadingEl.style.display = 'none';

  if (requests.length === 0) {
    problemsList.innerHTML = '<div class="no-problems">No active problems found. Try searching or adding one!</div>';
    return;
  }

  const grouped = { 'High': [], 'Medium': [], 'Low': [] };

  requests.forEach(req => {
    const level = (req.emergency_level || req.type || 'Low').toString().toLowerCase();
    const capLevel = level.charAt(0).toUpperCase() + level.slice(1);
    grouped[capLevel] = grouped[capLevel] || [];
    grouped[capLevel].push(req);

    const iconColor = levelIcons[capLevel] || 'green';
    const icon = createColoredIcon(iconColor);
    const marker = L.marker([req.latitude, req.longitude], {icon}).addTo(map);
    marker.bindPopup(`<b>${req.fullname}</b><br/>${req.aidtype}`);
    allMarkers.push(marker);
  });

  ['High', 'Medium', 'Low'].forEach(level => {
    if (grouped[level].length === 0) return;
    const section = document.createElement('div');
    section.className = `priority-section ${level.toLowerCase()}`;
    const levelHeading = document.createElement('h3');
    levelHeading.innerText = `${level} Priority (${grouped[level].length})`;
    section.appendChild(levelHeading);

    grouped[level].forEach(item => {
      const div = document.createElement('div');
      div.className = 'problem';
      div.innerHTML = `
        <div class="field"><strong>Name:</strong> ${item.fullname}</div>
        <div class="field"><strong>Location:</strong> ${item.address}</div>
        <div class="field"><strong>Aid Type:</strong> ${item.aidtype}</div>
      `;
      div.onclick = () => { map.flyTo([item.latitude, item.longitude], 15); };
      section.appendChild(div);
    });
    problemsList.appendChild(section);
  });
}

// Search function
function doSearch() {
  const val = document.getElementById('searchInput').value.trim();
  
  const cityCoords = {
    'delhi': [28.6139, 77.2090],
    'mumbai': [19.0760, 72.8777],
    'bangalore': [12.9716, 77.5946],
    'chennai': [13.0827, 80.2707],
    'kolkata': [22.5726, 88.3639],
    'hyderabad': [17.3850, 78.4867],
    'pune': [18.5204, 73.8567],
    'ahmedabad': [23.0225, 72.5714],
    'jaipur': [26.9124, 75.7873],
    'lucknow': [26.8467, 80.9462],
    'kanpur': [26.4499, 80.3319],
    'nagpur': [21.1458, 79.0882],
    'indore': [22.7196, 75.8577],
    'bhopal': [23.2599, 77.4126],
    'ludhiana': [30.9010, 75.8573],
    'agra': [27.1767, 78.0081],
    'varanasi': [25.3176, 82.9739],
    'srinagar': [34.0837, 74.7973],
    'amritsar': [31.6340, 74.8723],
    'chandigarh': [30.7333, 76.7794],
    'guwahati': [26.1445, 91.7362]
  };
  
  const searchKey = val.toLowerCase();
  
  if (cityCoords[searchKey]) {
    const [lat, lon] = cityCoords[searchKey];
    map.setView([lat, lon], 12);
    const marker = L.marker([lat, lon]).addTo(map);
    marker.bindPopup(`<b>${val}</b>`).openPopup();
  }
}

// Reset function
function resetSearch() {
  document.getElementById('searchInput').value = '';
  map.setView([23.5937, 80.9629], 5);
}

// Initialize
fetchRequests().then(results => {
  allRequests = results;
  renderMarkers(results);
});

function toggleMobileMenu() {
  const mobileNav = document.getElementById('mobile-nav');
  mobileNav.classList.toggle('hidden');
}

document.getElementById('addRequestBtn').onclick = function() {
  window.location.href = '../php/request.php';
};

</script>
</body>
</html>